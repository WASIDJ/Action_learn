name: 自动部署所有 Slidev 幻灯片

on:
  workflow_dispatch:    # 手动触发部署

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: 检出仓库代码
      uses: actions/checkout@v3

    - name: 设置 Node.js 环境
      uses: actions/setup-node@v3
      with:
        node-version: '22'

    - name: Install root dependencies
      working-directory: ./slidev学习
      run: npm install

    - name: 安装 Slidev（如果需要全局安装）
      run: npm install -g slidev || echo "全局安装失败，后续将使用 npx 运行 Slidev"

    - name: 查找 Slidev 项目目录
      id: find_projects
      run: |
        projects=$(find . -maxdepth 2 -type f -name "slides.md" | grep -v "^./slidev/")
        echo "找到的项目："
        echo "$projects"
        if [ -z "$projects" ]; then
          echo "projects=[]" >> $GITHUB_OUTPUT
          exit 0
        fi
        project_list=$(echo "$projects" | xargs -n1 dirname | sort -u)
        json=$(echo "$project_list" | jq -R -s -c 'split("\n")[:-1]')
        echo "projects=$json" >> $GITHUB_OUTPUT
      shell: bash



    - name: 构建所有 Slidev 项目
      run: |
        projects=${{ steps.find_projects.outputs.projects }}
        if [ "$projects" = "[]" ]; then
          exit 0
        fi
        echo "$projects" | jq -c '.[]' | while read project; do
          project=$(echo $project | tr -d '"')
          echo "正在构建项目：$project"
          cd "$project"
          if [ -f "package.json" ]; then
            npm install || echo "npm install 出错，但继续..."
          fi
          npx slidev build --base /slidev/$(basename "$project")/ || echo "构建失败：$project"
          cd - || exit 1
        done
      shell: bash

    - name: 复制构建产物到 GitHub Pages 目录
      run: |
        projects=${{ steps.find_projects.outputs.projects }}
        if [ "$projects" = "[]" ]; then
          exit 0
        fi
        echo "$projects" | jq -c '.[]' | while read project; do
          project=$(echo $project | tr -d '"')
          target="slidev/$(basename "$project")"
          mkdir -p "$target"
          if [ -d "$project/dist" ]; then
            cp -r "$project/dist/"* "$target/" || echo "复制错误"
          else
            echo "跳过 $project"
          fi
        done
      shell: bash

    - name: 提交并推送更新
      run: |
        git config --global user.name "GitHub Actions"
        git config --global user.email "actions@github.com"
        git add .
        git commit -m "自动部署所有 Slidev 幻灯片 [skip ci]" || echo "无变更"
        git push origin main || echo "推送失败"
      shell: bash
